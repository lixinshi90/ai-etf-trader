<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI ETF Trader ä»ªè¡¨ç›˜</title>
  <link rel="icon" href="data:,">
  <!-- Load local ECharts synchronously -->
  <script src="/static/echarts.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
    .container { max-width: 1400px; margin: 0 auto; margin-left: 220px; margin-right: 320px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
    .header h1 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .header-right { display: flex; align-items: center; gap: 20px; }
    .last-update { font-size: 13px; color: #666; display: flex; flex-direction: column; align-items: flex-end; }
    .last-update .time { font-weight: 600; color: #667eea; margin-top: 4px; }
    .btn { padding: 4px 8px; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 4px; }
    .btn-refresh { padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }
    .btn-refresh:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
    .auto-refresh { font-size: 12px; color: #999; }
    .error-banner { display: none; background: #fee; color: #c33; padding: 12px 16px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #c33; font-size: 13px; }
    .error-banner.show { display: block; }
    .card { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); margin-bottom: 24px; overflow: hidden; }
    .card-header { padding: 20px 24px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-bottom: 1px solid #e8eef5; display: flex; align-items: center; gap: 12px; }
    .card-header h2 { font-size: 18px; font-weight: 600; color: #333; margin: 0; }
    .card-header .icon { font-size: 20px; }
    .card-body { padding: 24px; }
    .chart-container { width: 100%; height: 420px; display: flex; align-items: center; justify-content: center; background: #fafbfc; border-radius: 8px; }
    .chart-placeholder { color: #999; font-size: 14px; text-align: center; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .metric-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2); }
    .metric-label { font-size: 12px; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .metric-value { font-size: 28px; font-weight: 700; font-family: 'Courier New', monospace; }
    .metric-unit { font-size: 12px; opacity: 0.8; margin-top: 4px; }
    .table-wrapper { overflow-x: auto; max-height: 500px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead { background: #f8f9fb; position: sticky; top: 0; z-index: 10; }
    th { padding: 12px 16px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e8eef5; }
    td { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; }
    .decision-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-weight: 600; font-size: 12px; text-transform: uppercase; }
    .decision-buy { background: #d4edda; color: #155724; }
    .decision-sell { background: #f8d7da; color: #721c24; }
    .decision-hold { background: #fff3cd; color: #856404; }
    .gain { color: #2ecc71; } .loss { color: #e74c3c; }
    .empty-state { display: none; text-align: center; padding: 40px 20px; color: #999; }
    .empty-state.show { display: block; }
    .mode-badge { background: #e0e0e0; color: #666; font-size: 12px; padding: 4px 8px; border-radius: 4px; font-weight: 600; }
    .tooltip-wrapper { position: relative; cursor: help; border-bottom: 1px dotted #999; display: inline-block; }
    .tooltip-text { visibility: hidden; width: 280px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 1000; bottom: 125%; left: 50%; margin-left: -140px; opacity: 0; transition: opacity 0.3s; font-size: 12px; line-height: 1.5; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
    .tooltip-wrapper:hover .tooltip-text { visibility: visible; opacity: 1; }
    /* Sidebar */
    .sidebar { position: fixed; left: 20px; top: 20px; bottom: 20px; width: 180px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 12px; overflow-y: auto; }
    .sidebar h3 { font-size: 14px; margin: 6px 0 10px; color: #444; }
    .nav-list { list-style: none; }
    .nav-list li { margin: 6px 0; }
    .nav-list a { text-decoration: none; color: #555; font-size: 13px; display: block; padding: 6px 8px; border-radius: 6px; }
    .nav-list a:hover { background: #f3f5ff; color: #333; }
    /* Rightbar (live tickers) */
    .rightbar { position: fixed; right: 20px; top: 20px; bottom: 20px; width: 300px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: block; overflow: hidden; }
    .rightbar-header { padding: 12px 14px; border-bottom: 1px solid #eef2f7; display: flex; align-items: center; justify-content: space-between; }
    .rightbar-header h3 { font-size: 14px; color: #444; }
    .rightbar-body { height: calc(100% - 48px); overflow-y: auto; padding: 10px 10px 12px; }
    .rb-head { position: sticky; top: 0; display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; font-size: 12px; color: #666; background: #fff; border-bottom: 1px solid #f0f0f0; z-index: 1; }
    .rb-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-radius: 8px; border: 1px solid #f0f0f0; margin-bottom: 8px; background: #fafbff; }
    .rb-code { font-weight: 700; font-size: 13px; }
    .rb-name { color: #888; font-size: 12px; margin-left: 6px; }
    .rb-price { font-weight: 700; font-size: 14px; }
    .rb-change { font-size: 12px; }
    .rb-gain { color: #2ecc71; }
    .rb-loss { color: #e74c3c; }
    @media (max-width: 1280px) { .rightbar { display: none !important; } .container { margin-right: 20px; } }
    /* Back to top */
    #backToTop { position: fixed; right: 24px; bottom: 24px; width: 44px; height: 44px; border: none; border-radius: 22px; background: #667eea; color: #fff; font-size: 18px; display: none; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 6px 16px rgba(102,126,234,0.4); }
    #backToTop.show { display: flex; }
    body { scroll-behavior: smooth; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h3>å¯¼èˆª</h3>
    <ul class="nav-list">
      <li><a href="#sec-performance">è´¦æˆ·æ€»èµ„äº§æ›²çº¿</a></li>
      <li><a href="#sec-portfolio">å®æ—¶èµ„äº§æ¦‚è§ˆ</a></li>
            <li><a href="#sec-kpi">å…³é”®ç»©æ•ˆæŒ‡æ ‡</a></li>
      <li><a href="#sec-positions">å½“å‰æŒä»“æ˜ç»†</a></li>
      <li><a href="#sec-trades">æœ€è¿‘äº¤æ˜“è®°å½•</a></li>
      <li><a href="#sec-decisions">æœ€è¿‘AIå†³ç­–</a></li>
      <li><a href="#sec-factors">å› å­é€Ÿè§ˆ</a></li>
      <li><a href="#sec-vega">æ³¢åŠ¨ç‡é£é™©ï¼ˆè¿‘ä¼¼ï¼‰</a></li>

    </ul>
  </div>
  <div class="container">
    <div class="header"><h1>ğŸ“Š AI ETF Trader ä»ªè¡¨ç›˜</h1><div class="header-right"><span id="liveSourceBadge" class="mode-badge" style="margin-right:10px;">æº: --</span><div class="last-update"><span>æœ€åæ›´æ–°</span><span class="time" id="lastUpdate">--:--:--</span></div><button class="btn-refresh" onclick="loadAll()">ğŸ”„ åˆ·æ–°</button><button class="btn-refresh" id="btnPull" onclick="refreshPrices()">ğŸ“¥ æ‹‰å–æœ€æ–°è¡Œæƒ…</button><div class="auto-refresh">è‡ªåŠ¨åˆ·æ–°: 10ç§’</div></div></div>
    <div id="globalError" class="error-banner"></div>
    <div class="content">
    <div id="sec-performance" class="card"><div class="card-header"><span class="icon">ğŸ“ˆ</span><h2>è´¦æˆ·æ€»èµ„äº§æ›²çº¿</h2><div style="margin-left:auto; display:flex; align-items:center; gap:8px;"><span id="modeLabel" class="mode-badge">äº¤æ˜“æ—¥</span><span class="muted">æ˜¾ç¤º</span><select id="tradingModeSelect" class="btn"><option value="1">äº¤æ˜“æ—¥</option><option value="0">è‡ªç„¶æ—¥</option></select></div></div><div class="card-body"><div id="performanceChart" class="chart-container"><div class="chart-placeholder">ğŸ“­ æš‚æ— æ•°æ®</div></div></div></div>
    <div id="sec-portfolio" class="card"><div class="card-header"><span class="icon">ğŸ’¹</span><h2>å®æ—¶èµ„äº§æ¦‚è§ˆ</h2></div><div class="card-body"><div class="metrics-grid"><div class="metric-card"><div class="metric-label">æ€»èµ„äº§(ä¼°å€¼)</div><div class="metric-value" id="p-total">0.00</div></div><div class="metric-card"><div class="metric-label">ç°é‡‘</div><div class="metric-value" id="p-cash">0.00</div></div><div class="metric-card"><div class="metric-label">æŒä»“å¸‚å€¼</div><div class="metric-value" id="p-hold">0.00</div></div></div></div></div>
    
    <div id="sec-kpi" class="card"><div class="card-header"><span class="icon">ğŸ¯</span><h2>å…³é”®ç»©æ•ˆæŒ‡æ ‡</h2></div><div class="card-body"><div class="metrics-grid"><div class="metric-card"><div class="metric-label"><span class="tooltip-wrapper">æ€»äº¤æ˜“æ¬¡æ•°<span class="tooltip-text">ç»Ÿè®¡å‘¨æœŸå†…ä¹°å…¥+å–å‡ºæ¬¡æ•°ï¼›ä¸‹æ–¹æ˜¾ç¤ºä¹°/å–æ˜ç»†</span></span></div><div class="metric-value" id="m-total">--</div><div class="metric-unit" id="m-total-detail">ä¹° 0 / å– 0</div></div><div class="metric-card"><div class="metric-label"><span class="tooltip-wrapper">èƒœç‡<span class="tooltip-text">ç›ˆåˆ©çš„å–å‡ºäº¤æ˜“æ¬¡æ•° / æ€»å–å‡ºäº¤æ˜“æ¬¡æ•°</span></span></div><div class="metric-value" id="m-win">--</div></div><div class="metric-card"><div class="metric-label"><span class="tooltip-wrapper">æ€»æ”¶ç›Šç‡<span class="tooltip-text">å…¬å¼: (æœŸæœ«æ€»èµ„äº§ - æœŸåˆæ€»èµ„äº§) / æœŸåˆæ€»èµ„äº§ Ã— 100%</span></span></div><div class="metric-value" id="m-totalret">--</div></div><div class="metric-card"><div class="metric-label"><span class="tooltip-wrapper">å¹´åŒ–æ”¶ç›Šç‡<span class="tooltip-text">å…¬å¼: æ€»æ”¶ç›Šç‡ Ã— (365 / ç»Ÿè®¡å¤©æ•°)</span></span></div><div class="metric-value" id="m-annual">--</div></div><div class="metric-card"><div class="metric-label"><span class="tooltip-wrapper">æœ€å¤§å›æ’¤<span class="tooltip-text">ç»Ÿè®¡å‘¨æœŸå†…ï¼Œè´¦æˆ·å‡€å€¼ä»ä»»æ„å†å²é«˜ç‚¹å›è½çš„æœ€å¤§ç™¾åˆ†æ¯”</span></span></div><div class="metric-value" id="m-mdd">--</div></div></div></div></div>
    <div id="sec-backtest" class="card"><div class="card-header"><span class="icon">ğŸ§ª</span><h2>ç­–ç•¥å›æµ‹</h2><div style="margin-left:auto; display:flex; align-items:center; gap:8px;"><label>å¼€å§‹</label><input type="date" id="bt-start" class="btn"><label>ç»“æŸ</label><input type="date" id="bt-end" class="btn"><button class="btn-refresh" id="bt-run" onclick="runBacktest()">â–¶ å¼€å§‹å›æµ‹</button></div></div><div class="card-body"><div class="metrics-grid"><div class="metric-card"><div class="metric-label">æ€»äº¤æ˜“æ¬¡æ•°</div><div class="metric-value" id="bt-total">--</div><div class="metric-unit" id="bt-total-detail">ä¹° 0 / å– 0</div></div><div class="metric-card"><div class="metric-label">èƒœç‡</div><div class="metric-value" id="bt-win">--</div></div><div class="metric-card"><div class="metric-label">æ€»æ”¶ç›Šç‡</div><div class="metric-value" id="bt-totalret">--</div></div><div class="metric-card"><div class="metric-label">å¹´åŒ–æ”¶ç›Šç‡</div><div class="metric-value" id="bt-annual">--</div></div><div class="metric-card"><div class="metric-label">æœ€å¤§å›æ’¤</div><div class="metric-value" id="bt-mdd">--</div></div></div><div id="backtestChart" class="chart-container" style="height: 360px; margin-top: 10px;"><div class="chart-placeholder">ğŸ“ˆ å›æµ‹æ”¶ç›Šæ›²çº¿</div></div><h3 style="margin:16px 0 8px;">æ¯æ—¥äº¤æ˜“åˆ†å¸ƒ</h3><div class="table-wrapper"><table id="bt-dist" style="display:none;"><thead><tr><th>æ—¥æœŸ</th><th>ä¹°å…¥</th><th>å–å‡º</th></tr></thead><tbody></tbody></table></div></div></div>
    <div id="sec-positions" class="card"><div class="card-header"><span class="icon">ğŸ“¦</span><h2>å½“å‰æŒä»“ï¼ˆå«åˆ†é…ï¼‰</h2></div><div class="card-body"><div id="posEmpty" class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-text">æš‚æ— æŒä»“</div></div><div id="allocationChart" class="chart-container" style="height: 360px; margin-bottom: 12px;"><div class="chart-placeholder">ğŸ“Š æš‚æ— æŒä»“</div></div><div class="table-wrapper"><table id="positionsTable" style="display:none;"><thead><tr><th>ETFä»£ç </th><th>æ•°é‡</th><th>æœ€æ–°ä»·</th><th>å¸‚å€¼</th></tr></thead><tbody></tbody></table></div></div></div>
    <div id="sec-trades" class="card"><div class="card-header"><span class="icon">ğŸ’°</span><h2>æœ€è¿‘äº¤æ˜“è®°å½•</h2></div><div class="card-body"><div id="tradesEmpty" class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-text">æš‚æ— äº¤æ˜“è®°å½•</div></div><div class="table-wrapper"><table id="tradesTable" style="display:none;"><thead><tr><th>æ—¥æœŸ</th><th>ETFä»£ç </th><th>æ“ä½œ</th><th>ä»·æ ¼</th><th>æ•°é‡</th><th>æ€»å€¼</th><th>æ“ä½œåèµ„é‡‘</th><th>ç†ç”±</th></tr></thead><tbody></tbody></table></div></div></div>
    <div id="sec-decisions" class="card"><div class="card-header"><span class="icon">ğŸ¤–</span><h2>æœ€è¿‘AIå†³ç­–</h2></div><div class="card-body"><div id="decisionsEmpty" class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-text">æš‚æ— AIå†³ç­–</div></div><div class="table-wrapper"><table id="decisionsTable"><thead><tr><th>æ—¥æœŸ</th><th>ETF</th><th>å†³ç­–</th><th>ç½®ä¿¡åº¦</th><th>åˆ†æç†ç”±</th></tr></thead><tbody></tbody></table></div></div></div>

    <div id="sec-factors" class="card">
      <div class="card-header">
        <span class="icon">ğŸ§®</span>
        <h2>å› å­é€Ÿè§ˆ</h2>
      </div>
      <div class="card-body">
        <div id="factorsEmpty" class="empty-state show">
          <div class="empty-state-icon">ğŸ“­</div>
          <div class="empty-state-text">æ­£åœ¨åŠ è½½å› å­æ•°æ®...</div>
        </div>
        <div class="table-wrapper">
          <table id="factorsTable" style="display:none;">
            <thead>
              <tr>
                <th>ä»£ç </th>
                <th>æ—¥æœŸ</th>
                <th>1æ—¥æ”¶ç›Š(%)</th>
                <th>20æ—¥æ³¢åŠ¨(å¹´åŒ–%)</th>
                <th>RSI(14)</th>
                <th>ç­–ç•¥æ¨¡å¼</th>
                <th>ç­–ç•¥å‚æ•°</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="sec-vega" class="card">
      <div class="card-header"><span class="icon">âš¡</span><h2>æ³¢åŠ¨ç‡é£é™©ï¼ˆè¿‘ä¼¼ï¼‰</h2><div style="margin-left:auto; display:flex; align-items:center; gap:8px;"><span class="muted">æ ‡çš„</span><select id="vegaSelect" class="btn"></select></div></div>
      <div class="card-body">
        <div id="vegaEmpty" class="empty-state show">
          <div class="empty-state-icon">ğŸ“­</div>
          <div class="empty-state-text">æ­£åœ¨åŠ è½½æ³¢åŠ¨ç‡é£é™©...</div>
        </div>
        <div id="vegaChart" class="chart-container" style="height:320px;">
          <div class="chart-placeholder">ğŸ“ˆ è¯·é€‰æ‹©æ ‡çš„æŸ¥çœ‹</div>
        </div>
        <div class="table-wrapper">
          <table id="vegaTable" style="display:none;">
            <thead>
              <tr>
                <th>ä»£ç </th>
                <th>åç§°</th>
                <th>æ—¥æœŸ</th>
                <th>å¹´åŒ–Ïƒ(%)</th>
                <th>Î”V</th>
                <th>ç´¯è®¡Î”V</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- options section removed -->
  </div>

  <button id="backToTop" title="è¿”å›é¡¶éƒ¨">â†‘</button>

  <!-- Right side live ticker bar (only shown when market is open) -->
  <div id="rightbar" class="rightbar">
    <div class="rightbar-header">
      <h3>ETF è¡Œæƒ…é€Ÿè§ˆ</h3>
      <div>
        <span id="rbStatus" class="mode-badge" style="margin-right:8px;">--</span>
        <span id="rbSource" class="mode-badge" style="margin-right:8px;">æº: --</span>
        <span id="rbClock" style="font-size:12px;color:#999;">--:--:--</span>
      </div>
    </div>
    <div class="rightbar-body" id="rightbarBody">
      <div class="empty-state show" id="rbEmpty" style="padding:12px;color:#999;">æ­£åœ¨åŠ è½½...</div>
    </div>
  </div>

  <script>
    // --- Globals & Chart Options ---
    let perfChart = null, allocChart = null, vegaChart = null;
    const perfOption = { tooltip: { trigger: 'axis' }, grid: { left: 60, right: 20, top: 20, bottom: 40 }, xAxis: { type: 'category' }, yAxis: { type: 'value', scale: true }, series: [{ type: 'line', smooth: true, data: [] }] };
    const allocOption = { tooltip: { trigger: 'item', formatter: '{b}: {c}å…ƒ ({d}%)' }, legend: { type: 'scroll', orient: 'vertical', right: 10, top: 20, bottom: 20 }, series: [{ name: 'æŒä»“åˆ†é…', type: 'pie', radius: ['40%', '70%'], center: ['40%', '50%'], avoidLabelOverlap: true, itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 }, label: { show: false }, emphasis: { label: { show: true, fontSize: '16', fontWeight: 'bold' } }, data: [] }] };
    const vegaOption = { tooltip: { trigger: 'axis' }, legend: { data: ['ç´¯è®¡Î”V','Ïƒ(%)'] }, grid: { left: 60, right: 60, top: 30, bottom: 40 }, xAxis: { type: 'category', data: [] }, yAxis: [ { type: 'value', name: 'ç´¯è®¡Î”V', scale: true }, { type: 'value', name: 'å¹´åŒ–Ïƒ(%)', scale: true, position: 'right' } ], series: [ { name:'ç´¯è®¡Î”V', type:'line', smooth:true, yAxisIndex:0, data: [] }, { name:'Ïƒ(%)', type:'line', smooth:true, yAxisIndex:1, data: [] } ] };

    // --- Helpers ---
    let codeNameMap = {};
    const setName = (code, name) => {
      if (!code) return;
      const nm = (name == null ? '' : String(name).trim());
      if (nm && nm !== '-' && nm.toLowerCase() !== 'none') {
        codeNameMap[String(code)] = nm;
      }
    };
    const getName = (code) => { const n = codeNameMap[String(code)] || ''; return n && n !== '-' ? n : null; };
    const codeWithName = (code) => { const n = getName(code); return n ? `${code} (${n})` : `${code}`; };

    const getTradingMode = () => document.getElementById('tradingModeSelect')?.value || '1';
    const updateModeLabel = () => { const el = document.getElementById('modeLabel'); if(el) el.textContent = getTradingMode() === '0' ? 'è‡ªç„¶æ—¥' : 'äº¤æ˜“æ—¥'; };
    const setLastUpdate = () => { const d = new Date(); document.getElementById('lastUpdate').textContent = d.toTimeString().split(' ')[0]; };
    const showError = (msg) => { const el = document.getElementById('globalError'); el.textContent = 'âš ï¸ ' + msg; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 5000); };
    const fetchJSON = async (url) => { const res = await fetch(url, { cache: 'no-store' }); if (!res.ok) throw new Error(url + ' -> HTTP ' + res.status); return await res.json(); };
    const formatPercent = (v) => (typeof v === 'number' && isFinite(v) ? v.toFixed(2) : '--') + (typeof v === 'number' && isFinite(v) ? '%' : '');
    const safeNum = (v) => (typeof v === 'number' && isFinite(v) ? v : null);
    const getDecisionClass = (d) => `decision-${d}`;
    const getDecisionText = (d) => ({'buy':'ä¹°å…¥','sell':'å–å‡º','hold':'æŒæœ‰'}[d]||d);
    
    // Global number formatter to avoid duplicate declarations
    const n2 = (x) => (typeof x === 'number' ? x.toFixed(2) : '0.00');

    // --- Load Functions ---
    async function loadPerformance() {
      if (typeof window.echarts === 'undefined') { setTimeout(loadPerformance, 200); return; }
      try {
        const mode = getTradingMode();
        let data = await fetchJSON(`/api/performance?trading=${mode}`);
        if ((!data || !data.dates || data.dates.length === 0) && mode === '1') {
          data = await fetchJSON('/api/performance?trading=0');
        }
        const chartDom = document.getElementById('performanceChart');
        if (!data || !data.dates || data.dates.length === 0) {
          chartDom.innerHTML = '<div class="chart-placeholder">ğŸ“­ æš‚æ— æ•°æ®</div>';
          if (perfChart && !perfChart.isDisposed()) { perfChart.dispose(); perfChart = null; }
          return;
        }
        if (!perfChart || perfChart.isDisposed()) {
          perfChart = echarts.init(chartDom);
        }
        perfOption.xAxis.data = data.dates;
        perfOption.series[0].data = data.values;
        perfChart.setOption(perfOption);
      } catch (e) { showError('åŠ è½½è´¦æˆ·æ›²çº¿å¤±è´¥: ' + e.message); }
    }

    async function loadPortfolio() {
      try {
        const p = await fetchJSON('/api/portfolio');
        const n2 = (x) => (typeof x === 'number' ? x.toFixed(2) : '0.00');
        document.getElementById('p-total').textContent = n2(p.total_value);

        // Handle sentinel for non-trading day or pre-market
        if (p.cash === -1) {
            document.getElementById('p-cash').textContent = "(å¾…å¼€ç›˜)";
            document.getElementById('p-hold').textContent = "(å¾…å¼€ç›˜)";
        } else {
            document.getElementById('p-cash').textContent = n2(p.cash);
            document.getElementById('p-hold').textContent = n2(p.holdings_value);
        }

        const pos = p.positions || [];
        const posEmpty = pos.length === 0;
        document.getElementById('posEmpty').classList.toggle('show', posEmpty);
        document.getElementById('positionsTable').style.display = posEmpty ? 'none' : 'table';
        const posTbody = document.querySelector('#positionsTable tbody');
        posTbody.innerHTML = '';
        pos.forEach(it => {
          const row = posTbody.insertRow();
          row.innerHTML = `<td>${codeWithName(it.etf_code)}</td><td>${n2(it.quantity)}</td><td>${n2(it.price)}</td><td>${n2(it.value)}</td>`;
        });

        if (typeof window.echarts !== 'undefined') {
          const allocDom = document.getElementById('allocationChart');
          if (posEmpty) {
            allocDom.innerHTML = '<div class="chart-placeholder">ğŸ“Š æš‚æ— æŒä»“</div>';
            if (allocChart && !allocChart.isDisposed()) { allocChart.dispose(); allocChart = null; }
          } else {
            if (!allocChart || allocChart.isDisposed()) {
              allocChart = echarts.init(allocDom);
            }
            allocOption.series[0].data = pos.map(it => ({ name: codeWithName(it.etf_code), value: n2(it.value) }));
            allocChart.setOption(allocOption);
          }
        }
      } catch (e) { /* silent */ }
    }

    const computeKpis = (dates, values) => {
      const n = (values||[]).length; if (!n) return {tr:0, an:0, mdd:0};
      const first = Number(values[0]||0), last = Number(values[n-1]||0);
      const days = Math.max(1, (new Date(dates[n-1]) - new Date(dates[0])) / 86400000);
      const tr = first > 0 ? (last-first)/first*100 : 0;
      const an = tr * (365.0/days);
      let peak = -Infinity, mdd = 0;
      for (const v of values) { if (v > peak) peak = v; const dd = peak > 0 ? (v-peak)/peak*100 : 0; if (dd < mdd) mdd = dd; }
      return {tr, an, mdd};
    };

    async function loadMetrics() {
      try {
        const m = await fetchJSON('/api/metrics');
        let perf = await fetchJSON(`/api/performance?trading=${getTradingMode()}`);
        if (!perf || !perf.dates || perf.dates.length === 0) perf = await fetchJSON('/api/performance?trading=0');

        document.getElementById('m-total').textContent = m.total_trades ?? 0;
        const tp = document.getElementById('m-total-detail');
        if (tp) tp.textContent = `ä¹° ${m.buy_count ?? 0} / å– ${m.sell_count ?? 0}`;
        document.getElementById('m-win').textContent = formatPercent(m.win_rate ?? 0);

        const fmt = (v) => (typeof v === 'number' && isFinite(v) ? v.toFixed(2) : '--');
        const [trEl, anEl, mdEl] = ['m-totalret', 'm-annual', 'm-mdd'].map(id => document.getElementById(id));

        const kpis = { tr: m.total_return, an: m.annualized_return, mdd: m.max_drawdown };
        let prevKpis = null;
        if (perf && perf.dates && perf.dates.length >= 2) {
          prevKpis = computeKpis(perf.dates.slice(0, -1), perf.values.slice(0, -1));
        }

        const applyValue = (el, val, negIsBad = true) => {
          if (typeof val !== 'number' || !isFinite(val)) { el.className = 'metric-value'; el.textContent = '--'; return; }
          el.className = `metric-value ${val >= 0 ? 'gain' : 'loss'}`;
          el.innerHTML = `${val >= 0 ? 'â†‘' : 'â†“'} ${fmt(val)}%`;
        };
        applyValue(trEl, kpis.tr);
        applyValue(anEl, kpis.an);
        applyValue(mdEl, kpis.mdd, false); // å›æ’¤è¶Šå°è¶Šå¥½ï¼Œè¿™é‡Œå›ºå®šçº¢è‰²å‘ä¸‹å±•ç¤º
      } catch (e) { showError('åŠ è½½æŒ‡æ ‡å¤±è´¥: ' + e.message); }
    }

    async function loadTrades() {
      const n2 = (x) => (typeof x === 'number' ? x.toFixed(2) : '0.00');
      const n3 = (x) => (typeof x === 'number' ? x.toFixed(3) : '0.000');
      try {
        const rows = await fetchJSON('/api/trades');
        const tbody = document.querySelector('#tradesTable tbody');
        tbody.innerHTML = '';
        const empty = !(rows && rows.length);
        document.getElementById('tradesEmpty').classList.toggle('show', empty);
        document.getElementById('tradesTable').style.display = empty ? 'none' : 'table';
        (rows || []).forEach(tr => {
          const row = tbody.insertRow();
          row.innerHTML = `<td>${tr.date || ''}</td><td>${codeWithName(tr.etf_code || '')}</td><td><span class=\"decision-badge ${getDecisionClass(tr.action)}\">${getDecisionText(tr.action)}</span></td><td>${n3(tr.price)}</td><td>${n2(tr.quantity)}</td><td>${n2(tr.value)}</td><td>${n2(tr.capital_after)}</td><td>${tr.reasoning || ''}</td>`;
        });
      } catch (e) { showError('åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥: ' + e.message); }
    }

    async function loadDecisions() {
      try {
        const rows = await fetchJSON('/api/decisions');
        const tbody = document.querySelector('#decisionsTable tbody');
        tbody.innerHTML = '';
        const empty = !(rows && rows.length);
        document.getElementById('decisionsEmpty').classList.toggle('show', empty);
        document.getElementById('decisionsTable').style.display = empty ? 'none' : 'table';
        (rows || []).forEach(d => {
            const row = tbody.insertRow();
            const confidence = typeof d.confidence === 'number' ? d.confidence : 0;
            row.innerHTML = `<td>${d.date || ''}</td><td>${codeWithName(d.etf || '')}</td><td><span class=\"decision-badge ${getDecisionClass(d.decision)}\">${getDecisionText(d.decision)}</span></td><td><div class=\"confidence-bar\"><div class=\"confidence-bar-bg\"><div class=\"confidence-bar-fill\" style=\"width: ${confidence * 100}%\"></div></div><span class=\"confidence-text\">${(confidence * 100).toFixed(0)}%</span></div></td><td>${d.reasoning || ''}</td>`;
        });
      } catch (e) { showError('åŠ è½½AIå†³ç­–å¤±è´¥: ' + e.message); }
    }

        async function loadTickers() {
      const n2 = (x) => (typeof x === 'number' ? x.toFixed(2) : '0.00');
      try {
        let data = await fetchJSON('/api/etf_tickers?live=1');
        let list = [];
        let marketOpen = undefined;
        let source = 'history';
        if (Array.isArray(data)) {
          list = data;
          source = 'history';
        } else if (data && Array.isArray(data.rows)) {
          list = data.rows;
          marketOpen = !!data.market_open;
          source = data.source || 'history';
        }

        try { (list || []).forEach(t => setName(t.code, t.name)); } catch(e) {}

        const rb = document.getElementById('rightbar');
        const rbBody = document.getElementById('rightbarBody');
        const rbClock = document.getElementById('rbClock');
        const rbStatus = document.getElementById('rbStatus');
        const rbSource = document.getElementById('rbSource');
        const liveSourceBadge = document.getElementById('liveSourceBadge');

        if (rbClock) { const d = new Date(); rbClock.textContent = d.toTimeString().split(' ')[0]; }
        if (rbStatus) {
          const open = !!marketOpen;
          rbStatus.textContent = open ? 'å¼€å¸‚' : 'é—­å¸‚';
          rbStatus.style.background = open ? '#d4edda' : '#eee';
          rbStatus.style.color = open ? '#155724' : '#666';
        }
        if (rbSource) { rbSource.textContent = 'æº: ' + (source || '--'); }
        if (liveSourceBadge) { liveSourceBadge.textContent = 'æº: ' + (source || '--'); }

        if (rb) rb.style.display = '';
        if (rbBody) {
          rbBody.innerHTML = '';
          const head = document.createElement('div');
          head.className = 'rb-head';
          head.innerHTML = '<div>ä»£ç  / åç§°</div><div>ä»·æ ¼ / æ¶¨è·Œå¹…</div>';
          rbBody.appendChild(head);
          if (!list || !list.length) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'empty-state show';
            emptyDiv.style.cssText = 'padding:12px;color:#999;';
            emptyDiv.textContent = 'æš‚æ— æ•°æ®';
            rbBody.appendChild(emptyDiv);
          } else {
            (list || []).forEach(ticker => {
              const isGain = Number(ticker.pct_change) >= 0;
              const changeClass = isGain ? 'rb-gain' : 'rb-loss';
              const changeArrow = isGain ? 'â†‘' : 'â†“';
              const item = document.createElement('div');
              item.className = 'rb-item';
              item.innerHTML = `
                <div>
                  <span class="rb-code">${ticker.code}</span>
                  <span class="rb-name">${ticker.name || '-'}</span>
                </div>
                <div style="text-align:right">
                  <div class="rb-price">${n2(Number(ticker.price))}</div>
                  <div class="rb-change ${changeClass}">${changeArrow} ${n2(Number(ticker.pct_change))}%</div>
                </div>
              `;
              rbBody.appendChild(item);
            });
          }
        }
      } catch (e) { showError('åŠ è½½ETFè¡Œæƒ…å¤±è´¥: ' + e.message); }
    }

    async function loadFactors() {
      const n2 = (x) => (typeof x === 'number' ? x.toFixed(2) : '0.00');
      const n4 = (x) => (typeof x === 'number' ? x.toFixed(4) : '0.0000');
      try {
        const rows = await fetchJSON('/api/qlib/factors');
        const tbody = document.querySelector('#factorsTable tbody');
        tbody.innerHTML = '';
        const empty = !(rows && rows.length);
        document.getElementById('factorsEmpty').classList.toggle('show', empty);
        document.getElementById('factorsTable').style.display = empty ? 'none' : 'table';
        (rows || []).sort((a,b)=>String(a.symbol).localeCompare(String(b.symbol))).forEach(f => {
          const row = tbody.insertRow();
          const strategy = f.strategy || {};
          const strategyMode = strategy.mode || '--';
          const strategyParams = strategy.mode ? `breakout_n=${strategy.breakout_n}, rsi_n=${strategy.rsi_n}, rsi_low=${strategy.rsi_low}, rsi_high=${strategy.rsi_high}` : '--';
          row.innerHTML = `
            <td>${codeWithName(f.symbol || '')}</td>
            <td>${(f.date || '').toString().slice(0,10)}</td>
            <td>${n2(f.ret_1d_pct)}</td>
            <td>${n2(f.vol_20d_pct)}</td>
            <td>${n2(f.rsi_14)}</td>
            <td><span class="mode-badge">${strategyMode}</span></td>
            <td style="font-size: 12px; color: #666;">${strategyParams}</td>
          `;
        });
      } catch (e) { showError('åŠ è½½å› å­å¤±è´¥: ' + e.message); }
    }

    async function loadOptions() {
      try {
        const sel = document.getElementById('optSelect');
        // 1) å‡†å¤‡æ ‡çš„ä¸‹æ‹‰ï¼šä¼˜å…ˆç”¨å®æ—¶tickersï¼Œå…¶æ¬¡å†å²
        let tickerData = await fetchJSON('/api/etf_tickers?live=1').catch(()=>null);
        if (!tickerData) tickerData = await fetchJSON('/api/etf_tickers').catch(()=>null);
        let list = [];
        if (Array.isArray(tickerData)) list = tickerData; else if (tickerData && Array.isArray(tickerData.rows)) list = tickerData.rows;
        // åç§°æ˜ å°„
        try { (list || []).forEach(t => setName(t.code, t.name)); } catch(e) {}
        if (sel) {
          const prev = (()=>{try{return localStorage.getItem('optCode')||'';}catch(e){return ''}})();
          const old = sel.value;
          sel.innerHTML = '';
          (list || []).forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.code;
            opt.textContent = codeWithName(t.code);
            sel.appendChild(opt);
          });
          if (prev && list.some(x=>String(x.code)===prev)) sel.value = prev; else if (old && list.some(x=>String(x.code)===old)) sel.value = old;
        }
        const code = document.getElementById('optSelect')?.value || (list && list[0] && list[0].code) || '';
        if (!code) {
          document.getElementById('optEmpty').classList.add('show');
          document.getElementById('optAtmTable').style.display='none';
          document.getElementById('optChainTable').style.display='none';
          return;
        }
        try { localStorage.setItem('optCode', code); } catch(e) {}
        // 2) ATM IV æ¦‚è§ˆ
        const atm = await fetchJSON(`/api/options/atm_iv?code=${code}`).catch(()=>null);
        const atmT = document.querySelector('#optAtmTable');
        const atmBody = document.querySelector('#optAtmTable tbody');
        atmBody.innerHTML = '';
        let atmRows = [];
        if (atm && atm.ok && Array.isArray(atm.rows)) atmRows = atm.rows; else if (atm && Array.isArray(atm.rows)) atmRows = atm.rows; else atmRows = [];
        const n2 = (x)=> (typeof x==='number' && isFinite(x) ? x.toFixed(2) : '--');
        const n4 = (x)=> (typeof x==='number' && isFinite(x) ? x.toFixed(4) : '--');
        if (atmRows.length) {
          document.getElementById('optEmpty').classList.remove('show');
          atmT.style.display='table';
          atmRows.sort((a,b)=>a.K-b.K).forEach(r => {
            const tr = atmBody.insertRow();
            tr.innerHTML = `<td>${(r.opt_type||'').toUpperCase()}</td><td>${n2(r.K)}</td><td>${r.T_days||'--'}</td><td>${n4(r.mid)}</td><td>${n2((typeof r.iv==='number'? r.iv*100 : null))}</td>`;
          });
        } else {
          atmT.style.display='none';
        }
        // 3) æœŸæƒé“¾ï¼ˆå«IV/Greeksï¼‰
        const chain = await fetchJSON(`/api/options/chain?code=${code}`).catch(()=>null);
        const chT = document.querySelector('#optChainTable');
        const chBody = document.querySelector('#optChainTable tbody');
        chBody.innerHTML = '';
        let chRows = [];
        if (chain && chain.ok && Array.isArray(chain.rows)) chRows = chain.rows; else if (chain && Array.isArray(chain.rows)) chRows = chain.rows; else chRows = [];
        if (chRows.length) {
          document.getElementById('optEmpty').classList.remove('show');
          chT.style.display='table';
          chRows.sort((a,b)=> (a.expiry||'').localeCompare(b.expiry||'') || a.K-b.K || (a.opt_type||'').localeCompare(b.opt_type||''));
          chRows.forEach(r => {
            const tr = chBody.insertRow();
            tr.innerHTML = `<td>${(r.opt_type||'').toUpperCase()}</td><td>${n2(r.K)}</td><td>${(r.expiry||'').toString().slice(0,10)}</td><td>${r.T_days||'--'}</td><td>${n4(r.price_mid)}</td><td>${n2((typeof r.iv==='number'? r.iv*100 : null))}</td><td>${n4(r.delta)}</td><td>${n4(r.gamma)}</td><td>${n4(r.vega)}</td><td>${n4(r.theta)}</td>`;
          });
        } else {
          chT.style.display='none';
        }
        if (!atmRows.length && !chRows.length) {
          document.getElementById('optEmpty').classList.add('show');
        }
      } catch (e) { showError('åŠ è½½æœŸæƒä¸IVå¤±è´¥: ' + e.message); }
    }

    async function runBacktest() {
      const startDate = document.getElementById('bt-start')?.value;
      const endDate = document.getElementById('bt-end')?.value;
      if (!startDate || !endDate) {
        showError('è¯·é€‰æ‹©å›æµ‹èµ·æ­¢æ—¥æœŸ');
        return;
      }

      // é»˜è®¤ä½¿ç”¨å½“å‰å·²çŸ¥çš„ä»£ç é›†åˆï¼šä¼˜å…ˆç”¨â€œè¡Œæƒ…é€Ÿè§ˆâ€é‡ŒåŠ è½½åˆ°çš„ codeNameMapï¼Œå…¶æ¬¡ç”¨æŒä»“è¡¨é‡Œçš„ä»£ç 
      let codes = Object.keys(codeNameMap || {});
      if (!codes || codes.length === 0) {
        try {
          const rows = Array.from(document.querySelectorAll('#positionsTable tbody tr'));
          codes = rows.map(r => (r.cells?.[0]?.textContent || '').split(' ')[0]).filter(Boolean);
        } catch (e) { codes = []; }
      }
      if (!codes || codes.length === 0) {
        showError('æ— æ³•è·å–å›æµ‹æ ‡çš„ codesï¼Œè¯·å…ˆåˆ·æ–°è¡Œæƒ…æˆ–é…ç½® ETF_LIST');
        return;
      }

      const btn = document.getElementById('bt-run');
      if (btn) { btn.disabled = true; btn.textContent = 'â³ å›æµ‹ä¸­...'; }

      try {
        const url = `/api/backtest?start=${encodeURIComponent(startDate)}&end=${encodeURIComponent(endDate)}&codes=${encodeURIComponent(codes.join(','))}`;
        const data = await fetchJSON(url);
        if (!data || data.ok !== true) {
          throw new Error((data && data.msg) || 'backtest failed');
        }

        const k = data.kpis || {};
        document.getElementById('bt-total').textContent = k.total_trades ?? '--';
        const btDetail = document.getElementById('bt-total-detail');
        if (btDetail) btDetail.textContent = `ä¹° ${k.buy_count ?? 0} / å– ${k.sell_count ?? 0}`;
        document.getElementById('bt-win').textContent = (typeof k.win_rate === 'number' ? k.win_rate.toFixed(2) : '--') + '%';
        document.getElementById('bt-totalret').textContent = (typeof k.total_return === 'number' ? k.total_return.toFixed(2) : '--') + '%';
        document.getElementById('bt-annual').textContent = (typeof k.annualized_return === 'number' ? k.annualized_return.toFixed(2) : '--') + '%';
        document.getElementById('bt-mdd').textContent = (typeof k.max_drawdown === 'number' ? k.max_drawdown.toFixed(2) : '--') + '%';

        // ç»˜åˆ¶å›æµ‹æ”¶ç›Šæ›²çº¿
        const eq = (data.equity || {});
        const dates = eq.dates || [];
        const values = eq.values || [];
        const chartDom = document.getElementById('backtestChart');
        if (typeof window.echarts !== 'undefined' && chartDom) {
          const opt = {
            tooltip: { trigger: 'axis' },
            grid: { left: 60, right: 20, top: 20, bottom: 40 },
            xAxis: { type: 'category', data: dates },
            yAxis: { type: 'value', scale: true },
            series: [{ type: 'line', smooth: true, data: values, name: 'Backtest Equity' }]
          };
          const inst = echarts.getInstanceByDom(chartDom);
          if (inst) inst.dispose();
          const c = echarts.init(chartDom);
          c.setOption(opt);
        }

        // æ¯æ—¥äº¤æ˜“åˆ†å¸ƒè¡¨
        const dist = data.daily_trades || [];
        const tb = document.getElementById('bt-dist');
        const body = document.querySelector('#bt-dist tbody');
        if (tb && body) {
          body.innerHTML = '';
          dist.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.date || ''}</td><td>${r.buy ?? 0}</td><td>${r.sell ?? 0}</td>`;
            body.appendChild(tr);
          });
          tb.style.display = dist.length ? 'table' : 'none';
        }
      } catch (e) {
        showError('å›æµ‹å¤±è´¥: ' + e.message);
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = 'â–¶ å¼€å§‹å›æµ‹'; }
      }
    }

    async function loadAll() {
      document.getElementById('globalError').classList.remove('show');
      await Promise.all([loadPortfolio(), loadPerformance(), loadMetrics(), loadTrades(), loadDecisions(), loadTickers(), loadFactors(), loadVega()]).catch(() => {});
      setLastUpdate();
    }

    async function loadVega() {
      try {
        // 1) æ±‡æ€»ï¼ˆç”¨äºè¡¨æ ¼ + ä¸‹æ‹‰æ¡†ï¼‰
        const summary = await fetchJSON('/api/vega_risk');
        const tbody = document.querySelector('#vegaTable tbody');
        const tableEl = document.getElementById('vegaTable');
        const emptyEl = document.getElementById('vegaEmpty');
        tbody.innerHTML = '';
        const list = Array.isArray(summary) ? summary : [];
        const empty = !(list && list.length);
        emptyEl.classList.toggle('show', empty);
        tableEl.style.display = empty ? 'none' : 'table';

        // ä»£ç ->åç§°æ˜ å°„ï¼ˆå¤ç”¨ï¼‰
        list.forEach(r => setName(r.code, r.name));

        list.forEach(r => {
          const row = tbody.insertRow();
          row.innerHTML = `<td>${codeWithName(r.code)}</td><td>${getName(r.code) || '-'}</td><td>${r.date || ''}</td><td>${(typeof r.sigma==='number'&&isFinite(r.sigma)?r.sigma.toFixed(2):'--')}</td><td>${(typeof r.delta_V==='number'&&isFinite(r.delta_V)?r.delta_V.toFixed(2):'--')}</td><td>${(typeof r.cum_delta_V==='number'&&isFinite(r.cum_delta_V)?r.cum_delta_V.toFixed(2):'--')}</td>`;
        });

        // 2) ä¸‹æ‹‰æ¡†
        const sel = document.getElementById('vegaSelect');
        const prev = (()=>{try{return localStorage.getItem('vegaCode')||'';}catch(e){return ''}})();
        if (sel) {
          const old = sel.value;
          sel.innerHTML = '';
          list.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r.code; opt.textContent = codeWithName(r.code);
            sel.appendChild(opt);
          });
          if (prev && list.some(r=>r.code===prev)) sel.value = prev;
          else if (old && list.some(r=>r.code===old)) sel.value = old;
        }

        // 3) å•æ ‡çš„æ›²çº¿
        const code = document.getElementById('vegaSelect')?.value || (list[0]?.code || '');
        if (!code) return;
        try { localStorage.setItem('vegaCode', code); } catch(e) {}
        const period = 120;
        const series = await fetchJSON(`/api/vega_risk?code=${code}&period=${period}`);
        const rows = (series && series.rows) ? series.rows : [];
        
        if (rows.length === 0) {
          console.warn('No vega data rows returned');
          return;
        }
        
        const dates = rows.map(r=>r.date);
        const cumdv = rows.map(r=> (typeof r.cum_delta_V==='number' && isFinite(r.cum_delta_V)) ? r.cum_delta_V : null);
        const sig = rows.map(r=> (typeof r.sigma==='number' && isFinite(r.sigma)) ? r.sigma : null);
        
        const chartDom = document.getElementById('vegaChart');
        if (!chartDom) {
          console.error('vegaChart DOM element not found');
          return;
        }
        
        // Dispose old chart if exists
        if (vegaChart && !vegaChart.isDisposed()) {
          vegaChart.dispose();
        }
        
        // Initialize new chart
        vegaChart = echarts.init(chartDom);
        vegaOption.xAxis.data = dates;
        vegaOption.series[0].data = cumdv;
        vegaOption.series[1].data = sig;
        vegaChart.setOption(vegaOption, true); // true = notMerge
        
        console.log(`Vega chart rendered with ${rows.length} data points`);
      } catch (e) { /* é™é»˜ */ }
    }

    async function refreshPrices() {
      const btn = document.getElementById('btnPull');
      if (btn) { btn.disabled = true; btn.textContent = 'â³ æ­£åœ¨æ‹‰å–...'; }
      try {
        const res = await fetch('/api/refresh_prices', { method: 'POST' });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error((data && data.msg) || 'åˆ·æ–°å¤±è´¥');
        await loadAll();
      } catch (e) { showError('æ‰‹åŠ¨æ‹‰å–å¤±è´¥: ' + e.message); }
      finally { if (btn) { btn.disabled = false; btn.textContent = 'ğŸ“¥ æ‹‰å–æœ€æ–°è¡Œæƒ…'; } }
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
      const sel = document.getElementById('tradingModeSelect');
      try { const saved = localStorage.getItem('tradingMode'); if (sel && saved) sel.value = saved; } catch(e) {}
      updateModeLabel();
      if (sel) sel.addEventListener('change', () => { try { localStorage.setItem('tradingMode', sel.value); } catch(e) {} updateModeLabel(); loadPerformance(); });
      // back-to-top toggle
      const btt = document.getElementById('backToTop');
      window.addEventListener('scroll', () => {
        if (!btt) return;
        if (window.scrollY > 300) btt.classList.add('show'); else btt.classList.remove('show');
      });
      if (btt) btt.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
      // init backtest date inputs (default: last 30 days)
      try {
        const s = document.getElementById('bt-start');
        const e = document.getElementById('bt-end');
        if (s && e) {
          const now = new Date();
          const end = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          const start = new Date(end.getTime() - 30 * 86400000);
          const fmt = (d)=> d.toISOString().slice(0,10);
          if (!s.value) s.value = fmt(start);
          if (!e.value) e.value = fmt(end);
        }
      } catch (e) {}

      loadAll();
      const vSel = document.getElementById('vegaSelect');
      if (vSel) vSel.addEventListener('change', () => { try { localStorage.setItem('vegaCode', vSel.value); } catch(e) {} loadVega(); });
      setInterval(loadAll, 10000);
    });
  </script>
</body>
</html>
