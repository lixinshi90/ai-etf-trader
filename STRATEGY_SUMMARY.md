# AI-ETF 交易系统策略总结

生成时间：2025-12-22
数据来源：项目代码分析 + README.md + 配置文件

---

## 📊 策略概览

您的系统采用 **AI + 规则 + Qlib 因子** 的混合决策架构，通过合议机制（CONSENSUS）确保信号可靠性，并配备完善的风控体系。

---

## 🎯 核心策略组成

### 1. 决策引擎（三层架构）

#### 第一层：规则信号（Rule-Based）
根据 `STRATEGY_MODE` 环境变量选择不同的技术指标组合：

**当前默认模式：AGGRESSIVE（激进模式）**
- 综合使用多种技术指标
- 可叠加 Qlib 因子判断

**可选模式**：
- **MA_CROSS**：20/60 均线金叉/死叉
- **BREAKOUT**：唐奇安通道突破（默认 N=20）
- **MEAN_REVERSION**：RSI(2) 超买/超卖（low=10, high=95）
- **KDJ_MACD**：J 值低位上穿 + MACD 金叉

#### 第二层：Qlib 因子（可选）
- **状态**：默认启用（`QLIB_FACTOR_ENABLED=true`）
- **数据源**：`data/qlib_factors/<code>.csv`
- **因子**：RSI14、20日波动率、1日收益率等
- **作用**：辅助规则信号，提供买/卖提示

#### 第三层：AI 决策（LLM）
- **模型**：支持 OpenAI 兼容 API
- **输入**：历史行情 + 技术指标 + 市场环境
- **输出**：结构化决策（buy/sell/hold + confidence + reasoning）
- **限流**：`DAILY_AI_CALLS_LIMIT`（默认不超过标的数）

### 2. 合议机制（CONSENSUS）

**核心逻辑**：
```
IF (AI决策 == 规则信号) AND (同为 buy 或 sell):
    执行该方向交易
ELSE:
    持有（hold）
```

**优势**：
- 降低噪音信号
- 提升胜率和稳健性
- 避免单一信号误判

---

## 💰 资金与仓位管理

### 基础配置
- **初始资金**：100,000 元
- **单笔最大仓位**：20% 当前现金
- **动态仓位**：支持根据 AI 置信度调整

### 仓位计算
```
基础仓位 = BASE_POSITION_PCT (默认 20%)
动态仓位 = 基础仓位 × AI置信度
最终仓位 = min(max(动态仓位, MIN_POSITION_PCT), MAX_POSITION_PCT)
```

**默认参数**：
- `BASE_POSITION_PCT`: 0.20 (20%)
- `MIN_POSITION_PCT`: 0.05 (5%)
- `MAX_POSITION_PCT`: 0.30 (30%)

---

## 🛡️ 风险控制体系

### 1. 强制止损
- **参数**：`HARD_STOP_LOSS_PCT`
- **逻辑**：浮亏超过阈值立即清仓
- **当前状态**：0.0（未启用）

### 2. 快速止盈
- **触发阈值**：`QUICK_TAKE_PROFIT_TRIGGER`
- **卖出比例**：`QUICK_TAKE_PROFIT_SELL_RATIO`
- **逻辑**：浮盈达到触发点时部分卖出
- **当前状态**：0.0（未启用）

### 3. 跟踪止损
- **启用开关**：`ENABLE_TRAILING_STOP`
- **止损幅度**：`TRAILING_STOP_PCT` (5%)
- **抬升步长**：`TRAILING_STEP_PCT` (1%)
- **逻辑**：价格创新高后抬升止损线，回撤即卖出
- **当前状态**：false（未启用）

### 4. 交易成本
根据 `config.yaml` 配置：
- **买入滑点**：0.1%
- **买入佣金**：0.05%
- **卖出滑点**：0.1%
- **卖出佣金**：0.05%
- **印花税**：0.1%

---

## 📈 标的池管理

### 当前配置
从诊断数据推断，您的标的池包括：
- **510300**（沪深300ETF）
- **159915**（创业板ETF）
- **159928**（消费ETF）
- **513100**（纳指ETF）
- **513500**（标普500ETF）
- **512040**（半导体ETF）
- 等共 14 只 ETF

### 标的池结构
支持两层结构：
- **核心池**（`CORE_ETF_LIST`）：优先处理
- **观察池**（`OBSERVE_ETF_LIST`）：核心池无买信号时处理

### 过滤条件
- **流动性**：`MIN_AVG_TURNOVER`（最小平均成交额）
- **上市时长**：`MIN_LISTING_MONTHS`（最小上市月数）

---

## 🔄 执行流程（每日收盘后）

### 1. 数据获取
- 通过 akshare 拉取 ETF 日线数据
- 优先东方财富，失败回退新浪
- 存储到 `data/etf_data.db`

### 2. 信号生成
- 计算技术指标（KDJ、MACD、RSI等）
- 读取 Qlib 因子（如已生成）
- 生成规则信号

### 3. AI 决策
- 调用 LLM 生成结构化决策
- 受 `DAILY_AI_CALLS_LIMIT` 限制

### 4. 合议执行
- 规则信号 + AI 决策 → 合议
- 同向则执行，否则持有

### 5. 风控检查
- 检查止损/止盈条件
- 计算仓位和成本
- 执行交易

### 6. 记录更新
- 写入 `trades` 表
- 更新 `daily_equity` 表
- 生成决策 JSON 文件

---

## 📊 当前运行状态

### 资产状况（截至 2025-12-19）
- **总资产**：99,275.50 元
- **现金**：58,549.10 元
- **持仓市值**：40,726.41 元
- **持仓数量**：4 只

### 交易统计
- **总交易次数**：43 笔
- **买入**：34 笔
- **卖出**：9 笔
- **交易周期**：2025-11-26 至 2025-12-19

### 绩效指标
- **总收益率**：-0.72%
- **最大回撤**：约 2.24%
- **胜率**：需根据实际盈亏配对计算

---

## 🎨 策略特点

### 优势
1. **多维度决策**：AI + 规则 + 因子，降低单一信号风险
2. **合议机制**：提升信号可靠性
3. **灵活配置**：支持多种策略模式切换
4. **完善风控**：止损/止盈/跟踪止损
5. **成本考虑**：真实模拟交易成本

### 风险点
1. **AI 依赖**：需要稳定的 API 调用
2. **因子滞后**：Qlib 因子计算在决策之后
3. **参数敏感**：多个参数需要优化
4. **回测不足**：需要更长周期验证

---

## 🔧 优化建议

### 短期（立即可做）
1. **启用风控**：
   ```
   HARD_STOP_LOSS_PCT=0.08
   QUICK_TAKE_PROFIT_TRIGGER=0.10
   QUICK_TAKE_PROFIT_SELL_RATIO=0.5
   ```

2. **优化仓位**：
   ```
   ENABLE_DYNAMIC_POSITION=true
   BASE_POSITION_PCT=0.15
   ```

### 中期（1-2周）
1. **回测验证**：使用历史数据回测不同参数组合
2. **因子优化**：调整 Qlib 因子计算时机
3. **标的筛选**：根据流动性和波动率优化标的池

### 长期（1个月+）
1. **策略迭代**：根据实盘表现调整规则
2. **风控升级**：引入波动率自适应止损
3. **组合优化**：考虑标的相关性，优化配置

---

## 📚 相关文件

### 核心代码
- `src/main.py` - 主任务调度
- `src/ai_decision.py` - AI 决策
- `src/trade_executor.py` - 交易执行与风控
- `src/web_app.py` - Web 接口

### 配置文件
- `config.yaml` - 基础配置
- `.env` - 环境变量（需创建）

### 数据文件
- `data/trade_history.db` - 交易历史
- `data/etf_data.db` - ETF 行情数据
- `data/qlib_factors/` - Qlib 因子

---

## 🎯 策略评价

**适用场景**：
- 中长期趋势跟踪
- 多标的轮动
- 风险可控的量化交易

**不适用场景**：
- 高频交易
- 日内交易
- 极端市场环境

**总体评价**：
您的策略架构完整，逻辑清晰，具备实盘运行的基础。建议先在小资金量下运行，积累数据后再逐步优化参数。

---

**生成时间**：2025-12-22
**数据来源**：项目代码 + 数据库分析
**状态**：当前运行中

