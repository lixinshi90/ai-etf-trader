# 重新执行今日任务 - 完整操作指南

日期：2025-12-22
目标：修正错误净值并应用新配置

---

## 🎯 执行目标

1. 修正今日错误净值（110049.91 → 121818.35）
2. 应用新的风控参数
3. 让新增7只ETF参与决策
4. 可选：调整AI调用上限

---

## ✅ 前置检查（已完成）

- [x] 今天是交易日（2025-12-22，星期一）
- [x] 配置已优化（config.yaml + .env）
- [x] 新增ETF数据已就绪（33只ETF）
- [x] 数据库已备份

---

## 📋 执行步骤

### 步骤 1：删除今日数据

在 PowerShell 中执行：
```powershell
python delete_today_simple.py
```

**预期输出**：
```
删除 2025-12-22 的数据...
删除净值记录: 1 条
删除交易记录: 0 笔
完成！
```

---

### 步骤 2：调整AI调用上限（可选）

用记事本打开 `.env` 文件：
```powershell
notepad .env
```

找到这一行：
```
DAILY_AI_CALLS_LIMIT=8
```

**选项**：
- **保持 8**：只有核心池的前8只ETF调用AI（节省API额度）
- **改为 12**：核心池9只 + 观察池前3只（推荐）
- **改为 21**：所有ETF都调用AI（最全面，但消耗多）

**我的建议**：改为 **12**

保存并关闭文件。

---

### 步骤 3：重新执行今日任务

```powershell
python -m src.daily_once
```

**执行过程**（预计 5-15 分钟）：

1. **数据拉取**（1-2分钟）
   - 拉取21只ETF的最新行情
   - 更新 `data/etf_data.db`

2. **信号生成**（1-2分钟）
   - 计算技术指标
   - 读取Qlib因子
   - 生成规则信号

3. **AI决策**（3-10分钟，取决于AI调用次数）
   - 调用AI生成决策
   - 保存决策JSON文件

4. **合议执行**（1分钟）
   - 规则 + AI 合议
   - 应用风控参数
   - 执行交易

5. **数据更新**（1分钟）
   - 写入交易记录
   - 更新今日净值
   - 导出CSV

**观察要点**：
- 是否有新的买入/卖出信号
- 风控是否触发（止损/止盈）
- 新增ETF是否参与决策

---

### 步骤 4：验证结果

```powershell
python check_today_status.py
```

**验证项**：
- [ ] 今日净值约为 121818.35（正确值）
- [ ] 今日交易记录数（可能为0或有新交易）
- [ ] AI决策文件数量（8-21个，取决于DAILY_AI_CALLS_LIMIT）

---

### 步骤 5：刷新Web页面

在浏览器中：
1. 按 **Ctrl + F5** 强制刷新
2. 检查"实时资产概览"：
   - 总资产应为 121818.35
   - 现金和持仓市值应正常显示
3. 检查其他模块是否正常

---

## ⚠️ 可能遇到的问题

### 问题 1：/api/trades 返回 500 错误

**原因**：数据库中某些字段包含无效数据

**解决**：
- 我已经增强了错误处理
- Web服务会自动重启并应用修复
- 如仍有问题，查看后端终端的错误信息

### 问题 2：AI调用失败

**原因**：API配置错误或额度不足

**解决**：
- 检查 `.env` 中的 `AI_API_KEY`
- 检查网络连接
- 查看 `logs/daily.log` 的错误信息

### 问题 3：数据拉取失败

**原因**：网络问题或akshare接口异常

**解决**：
- 稍后重试
- 检查网络连接
- 查看终端错误信息

---

## 🔄 如果需要回滚

如果重新执行后发现问题，可以恢复备份：

```powershell
# 停止Web服务（Ctrl+C）

# 恢复备份
copy data\trade_history.backup_20251222_before_rerun.db data\trade_history.db

# 重启Web服务
python -m src.web_app
```

---

## 📊 预期结果

### 重新执行后

**数据修正**：
- 今日净值：121818.35（正确）
- 总资产增长：+22.7%（相比昨日99275.50）

**新配置应用**：
- 风控参数生效
- 新仓位参数生效
- 新增7只ETF参与决策

**可能的交易**：
- 根据AI决策，可能产生新的买入/卖出
- 风控可能触发止盈（如有浮盈>10%的持仓）

---

## 🚀 开始执行

现在请执行：

```powershell
# 1. 删除今日数据
python delete_today_simple.py

# 2. 调整AI上限（可选）
notepad .env
# 修改 DAILY_AI_CALLS_LIMIT=12

# 3. 重新执行任务
python -m src.daily_once

# 4. 验证结果
python check_today_status.py
```

执行过程中如有任何问题，请随时告诉我！

